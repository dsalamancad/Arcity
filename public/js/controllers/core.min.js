var my_angular_app=angular.module("my_angular_app",[]);my_angular_app.service("coneccion",function(){var e=io(),t={};e.on("mapaFiltrado",function(e){t[e.guid](e.geojson),delete t[e.guid]});var n=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},r=function(r){var i=n();t[i]=r.callback,r.caller=i,e.emit("filtrarHora",r)};return{llamarFiltroporHora:r}}),my_angular_app.controller("home_controller",["$scope","coneccion",function(e,t){var r,i=(io(),function(e){var t="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",n='Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',i=(new L.TileLayer(t,{maxZoom:18,attribution:n}),L.map("map").setView([4.607038,-74.068819],16)),a=new L.FeatureGroup;i.addLayer(new L.TileLayer(t,{maxZoom:18,attribution:n,opacity:.4})),i._layersMaxZoom=18,i._layersMinZoom=10,L.control.scale({position:"bottomleft",imperial:!1}).addTo(i);var o=e.features,s=d3.time.format("%Y-%m-%dT%H:%M:%S.%LZ"),u=d3.time.format("%Y"),l=d3.time.format("%m"),c=d3.time.format("%d"),f=d3.time.format("%H");o.forEach(function(e){e.properties.seguidores=+e.properties.seguidores,e.properties.respondido=+e.properties.respondido,e.properties.fecha_fecha=s.parse(e.properties.fecha),e.properties.fecha_ano=+u(e.properties.fecha_fecha),e.properties.fecha_mes=+l(e.properties.fecha_fecha),e.properties.fecha_dia=+c(e.properties.fecha_fecha),e.properties.fecha_hora=+f(e.properties.fecha_fecha),e.properties.policia=+e.properties.policia,e.properties.canecas=+e.properties.canecas});var h=crossfilter(o),p=h.dimension(function(e){return e.properties.fecha_ano}),d=h.dimension(function(e){return e.properties.fecha_mes}),g=h.dimension(function(e){return e.properties.fecha_dia}),m=h.dimension(function(e){return e.properties.seguidores}),v=h.dimension(function(e){return e.properties.respondido}),y=h.dimension(function(e){return e.properties}),_=h.dimension(function(e){return e.properties.fecha_fecha}),x=(h.dimension(function(e){return e.properties.policia}),h.dimension(function(e){return e.properties.canecas}),h.groupAll()),w=p.group().reduceCount(),T=d.group().reduceCount(),S=(g.group().reduceCount(),m.group().reduceCount()),R=v.group().reduceCount(),N=(_.group().reduceCount(),_.group().reduceSum(function(e){return e.properties.policia})),P=_.group().reduceSum(function(e){return e.properties.arbol}),O=_.group().reduceSum(function(e){return e.properties.caneca}),k=_.group().reduceSum(function(e){return e.properties.estacion}),I=_.group().reduceSum(function(e){return e.properties.juego}),M=_.group().reduceSum(function(e){return e.properties.silla}),q=(_.group().reduceSum(function(e){return e.properties.luz}),_.bottom(1)[0].properties.fecha_fecha),B=_.top(1)[0].properties.fecha_fecha,U=dc.pieChart("#graficaAnual"),F=dc.pieChart("#graficaMensual"),j=dc.barChart("#usuariosPorReporte"),G=dc.pieChart("#reportesRespondidos"),H=dc.dataCount("#data-count"),z=dc.dataTable("#data-table"),$=dc.lineChart("#lineaDetiempo"),W=dc.compositeChart("#evolucionTiempo"),V=dc.compositeChart("#reportesTotales"),Z=d3.scale.ordinal().domain(["Policias","Árboles","Basuras","Acceso","Juegos","Sillas","Luz"]),Y=h.dimension(function(e){return e.properties}),K=Y.group().reduceSum(function(e){return e.properties.policia}),X=Y.group().reduceSum(function(e){return e.properties.arbol}),Q=Y.group().reduceSum(function(e){return e.properties.caneca}),J=Y.group().reduceSum(function(e){return e.properties.estacion}),ee=Y.group().reduceSum(function(e){return e.properties.juego}),te=Y.group().reduceSum(function(e){return e.properties.silla}),ne=Y.group().reduceSum(function(e){return e.properties.luz});V.width(630).height(150).x(Z).xUnits(dc.units.ordinal).elasticY(!1).compose([dc.barChart(V).group(K,"Policias").ordinalColors(["#0070bb"]),dc.barChart(V).group(X,"Árboles").ordinalColors(["#30bb51"]),dc.barChart(V).group(Q,"Basuras").ordinalColors(["#bc6731"]),dc.barChart(V).group(J,"Acceso").ordinalColors(["#ffb92e"]),dc.barChart(V).group(ee,"Juegos").ordinalColors(["#e31b20"]),dc.barChart(V).group(te,"Sillas").ordinalColors(["#5a31bc"]),dc.barChart(V).group(ne,"Luces").ordinalColors(["#dfdc13"])]),$.width(1060).height(80).dimension(_).group(K).renderVerticalGridLines(!0).margins({top:10,right:80,bottom:20,left:30}).filter(dc.filters.RangedFilter(q,B)).x(d3.time.scale().domain([q,B])),W.width(1060).height(150).dimension(_).margins({top:10,right:80,bottom:20,left:30}).x(d3.time.scale().domain([q,B])).brushOn(!1).legend(dc.legend().x(1e3).y(10).itemHeight(13).gap(5)).compose([dc.lineChart(W).group(N,"Policias").ordinalColors(["#0070bb"]),dc.lineChart(W).group(P,"Árboles").ordinalColors(["#30bb51"]),dc.lineChart(W).group(O,"Canecas").ordinalColors(["#bc6731"]),dc.lineChart(W).group(k,"Estaciones").ordinalColors(["#ffb92e"]),dc.lineChart(W).group(I,"Juegos").ordinalColors(["#e31b20"]),dc.lineChart(W).group(M,"Sillas").ordinalColors(["#5a31bc"]),dc.lineChart(W).group(k,"Luces").ordinalColors(["#dfdc13"])]),U.width(120).height(120).dimension(p).group(w).innerRadius(20).ordinalColors(["#3182bd","#cc4878","#4c001c","#ccbe48","#4c4400","#00bf75","#01663f","#cc4602","#592d16","#000be6","#000566","#c951e6"]),F.width(120).height(120).dimension(d).group(T).innerRadius(20).ordinalColors(["#3182bd","#cc4878","#4c001c","#ccbe48","#4c4400","#00bf75","#01663f","#cc4602","#592d16","#000be6","#000566","#c951e6"]),j.width(360).height(140).dimension(m).group(S).x(d3.scale.linear().domain([0,11])).elasticY(!1).centerBar(!1).barPadding(.3).yAxisLabel("No. de Intervenciones").margins({top:10,right:20,bottom:20,left:40}).ordinalColors(["#3182bd","#cc4878","#4c001c","#ccbe48","#4c4400","#00bf75","#01663f","#cc4602","#592d16","#000be6","#000566","#c951e6"]),j.xAxis().tickValues([" ",0,1,2,3,4,5,6,7,8,9,10," "]),G.width(140).height(140).dimension(v).group(R).innerRadius(20).ordinalColors(["#3182bd","#cc4878","#4c001c","#ccbe48","#4c4400","#00bf75","#01663f","#cc4602","#592d16","#000be6","#000566","#c951e6"]),H.dimension(h).group(x),z.dimension(y).group(function(e){return"dc.js insists on putting a row here so I remove it using JS"}).size(100).columns([function(e){return e.properties.id},function(e){return e.properties.usuario},function(e){return e.properties.fecha_ano},function(e){return e.properties.fecha_mes},function(e){return e.properties.descripcio},function(e){return e.properties.seguidores},function(e){var t;return t="<img style='width:500px' src='imagenes/capturasReportes/"+e.properties.id+".jpg' >"}]).sortBy(function(e){return e.properties.seguidores}).order(d3.descending).on("renderlet",function(e){e.select("tr.dc-table-group").remove(),a.clearLayers(),y.top(1/0).forEach(function(e){var t=e.geometry,n=3,r=L.circleMarker([t.coordinates[1],t.coordinates[0]],{fillColor:"#2354ae",color:"#fff",weight:.5,opacity:1,fillOpacity:.8,radius:n});r.bindPopup("<div id='popUpMarker'><img style='width:150px' src='imagenes/capturasReportes/"+e.properties.id+".jpg' > <div id='fecha'><span>fecha: </span>"+e.properties.fecha_dia+"/"+e.properties.fecha_mes+"/"+e.properties.fecha_ano+"</div><div id='votos'><span>Likes: </span>"+e.properties.seguidores+"</div><div id='elementosUsados'> <div id='tituloelementosusados'> <span>Elementos Usados:</span> </div><div><img src='imagenes/iconos/iconoPolicia.png'><span class='valorenpopup'>"+e.properties.policia+"</span></div><div><img src='imagenes/iconos/iconoCaneca.png'><span class='valorenpopup'>"+e.properties.caneca+"</span></div><div><img src='imagenes/iconos/iconoSilla.png'><span class='valorenpopup'>"+e.properties.silla+"</span></div><div><img src='imagenes/iconos/iconoEstacion.png'><span class='valorenpopup'>"+e.properties.estacion+"</span></div><div><img src='imagenes/iconos/iconoJuego.png'><span class='valorenpopup'>"+e.properties.juego+"</span></div><div><img src='imagenes/iconos/iconoArbol.png'><span class='valorenpopup'>"+e.properties.arbol+"</span></div><div><img src='imagenes/iconos/iconoLuz.png'><span class='valorenpopup'>"+e.properties.luz+"</div></div></div>"),a.addLayer(r)}),i.addLayer(a),i.fitBounds(a.getBounds())}),d3.selectAll("a#resetearTodo").on("click",function(){dc.filterAll(),dc.renderAll()}),d3.selectAll("a#resetearAno").on("click",function(){U.filterAll(),dc.redrawAll()}),d3.selectAll("a#resetearMes").on("click",function(){F.filterAll(),dc.redrawAll()}),d3.selectAll("a#resetearDia").on("click",function(){graficaDia.filterAll(),dc.redrawAll()}),d3.selectAll("a#resetearVotos").on("click",function(){j.filterAll(),dc.redrawAll()}),d3.selectAll("a#resetearRespondidos").on("click",function(){G.filterAll(),dc.redrawAll()}),dc.renderAll()});e.filtrarPorValor=function(){d3.selectAll("#capad3Hora svg").remove(),map.removeLayer(r),t.llamarFiltroporHora({callback:i,horaInicial:e.horaInicialFiltro,horaFinal:e.horaFinalFiltro})},t.llamarFiltroporHora({callback:i,horaInicial:0,horaFinal:24})}]);