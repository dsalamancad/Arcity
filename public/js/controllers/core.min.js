var my_angular_app=angular.module("my_angular_app",[]);my_angular_app.service("coneccion",function(){var e=io(),t={};e.on("mapaFiltrado",function(e){t[e.guid](e.geojson),delete t[e.guid]});var n=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},r=function(r){var i=n();t[i]=r.callback,r.caller=i,e.emit("filtrarHora",r)};return{llamarFiltroporHora:r}}),my_angular_app.controller("home_controller",["$scope","coneccion",function(e,t){var r,a=(io(),function(e){console.log(e);var t="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",n='Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',i=(new L.TileLayer(t,{maxZoom:18,attribution:n}),L.map("map").setView([4.607038,-74.068819],16)),a=new L.FeatureGroup;i.addLayer(new L.TileLayer(t,{maxZoom:18,attribution:n})),i._layersMaxZoom=18,i._layersMinZoom=10,L.control.scale({position:"bottomleft",imperial:!1}).addTo(i);var o=e.features,s=d3.time.format("%Y-%m-%dT%H:%M:%SZ"),u=d3.time.format("%Y"),l=d3.time.format("%m"),c=d3.time.format("%d"),f=d3.time.format("%H");o.forEach(function(e){e.properties.seguidores=+e.properties.seguidores,e.properties.respondido=+e.properties.respondido,e.properties.fecha_fecha=s.parse(e.properties.fecha),e.properties.fecha_ano=+u(e.properties.fecha_fecha),e.properties.fecha_mes=+l(e.properties.fecha_fecha),e.properties.fecha_dia=+c(e.properties.fecha_fecha),e.properties.fecha_hora=+f(e.properties.fecha_fecha)});var h=crossfilter(o),p=h.dimension(function(e){return e.properties.fecha_ano}),d=h.dimension(function(e){return e.properties.fecha_mes}),g=h.dimension(function(e){return e.properties.fecha_dia}),m=h.dimension(function(e){return e.properties.seguidores}),v=h.dimension(function(e){return e.properties.respondido}),y=h.dimension(function(e){return e.properties}),_=h.dimension(function(e){return e.properties.fecha_fecha}),b=h.groupAll(),E=p.group().reduceCount(),x=d.group().reduceCount(),T=(g.group().reduceCount(),m.group().reduceCount()),A=v.group().reduceCount(),R=(_.group().reduceCount(),_.bottom(1)[0].properties.fecha_fecha),C=_.top(1)[0].properties.fecha_fecha,N=dc.pieChart("#graficaAnual"),O=dc.pieChart("#graficaMensual"),P=dc.barChart("#usuariosPorReporte"),k=dc.pieChart("#reportesRespondidos"),I=dc.dataCount("#data-count"),M=dc.dataTable("#data-table"),D=dc.lineChart("#lineaDetiempo");D.width(1e3).height(70).dimension(_).group(T).renderVerticalGridLines(!0).x(d3.time.scale().domain([R,C])),N.width(120).height(120).dimension(p).group(E).innerRadius(20).ordinalColors(["#044265","#cc4878","#4c001c","#ccbe48","#4c4400","#00bf75","#01663f","#cc4602","#592d16","#000be6","#000566","#c951e6"]),O.width(120).height(120).dimension(d).group(x).innerRadius(20).ordinalColors(["#044265","#cc4878","#4c001c","#ccbe48","#4c4400","#00bf75","#01663f","#cc4602","#592d16","#000be6","#000566","#c951e6"]),P.width(400).height(160).dimension(m).group(T).x(d3.scale.linear().domain([0,10])).elasticY(!0).centerBar(!0).barPadding(.3).xAxisLabel("Votos / Likes").yAxisLabel("No. de Intervenciones").margins({top:10,right:20,bottom:50,left:40}).ordinalColors(["#044265","#cc4878","#4c001c","#ccbe48","#4c4400","#00bf75","#01663f","#cc4602","#592d16","#000be6","#000566","#c951e6"]),P.xAxis().tickValues([0,1,2,3,4,5,6,7,8,9,10]),k.width(120).height(120).dimension(v).group(A).innerRadius(20).ordinalColors(["#044265","#cc4878","#4c001c","#ccbe48","#4c4400","#00bf75","#01663f","#cc4602","#592d16","#000be6","#000566","#c951e6"]),I.dimension(h).group(b),M.dimension(y).group(function(e){return"dc.js insists on putting a row here so I remove it using JS"}).size(100).columns([function(e){return e.properties.usuario},function(e){return e.properties.fecha_ano},function(e){return e.properties.fecha_mes},function(e){return e.properties.descripcio},function(e){return e.properties.seguidores}]).sortBy(function(e){return e.properties.seguidores}).order(d3.descending).on("renderlet",function(e){e.select("tr.dc-table-group").remove(),a.clearLayers(),y.top(1/0).forEach(function(e){var t=e.geometry,n=L.marker([t.coordinates[1],t.coordinates[0]]);n.bindPopup("<div id='popUpMarker'> <div id='fecha'><span>fecha: </span>"+e.properties.fecha_fecha+"</div><div id='votos'><span>Votos: </span>"+e.properties.seguidores+"</div><div id='elementosUsados'> <div> <span>Elementos Usados:</span> </div><div><span>Policias: </span>1</div><div><span>Canecas: </span>2</div><div><span>Asientos: </span>0</div><div><span>Paraderos: </span>1</div><div><span>Juegos: </span>3</div><div><span>Árboles: </span>2</div><div><span>Luces: </span>0</div></div></div>"),a.addLayer(n)}),i.addLayer(a),i.fitBounds(a.getBounds())}),d3.selectAll("a#resetearTodo").on("click",function(){dc.filterAll(),dc.renderAll()}),d3.selectAll("a#resetearAno").on("click",function(){N.filterAll(),dc.redrawAll()}),d3.selectAll("a#resetearMes").on("click",function(){O.filterAll(),dc.redrawAll()}),d3.selectAll("a#resetearDia").on("click",function(){graficaDia.filterAll(),dc.redrawAll()}),d3.selectAll("a#resetearVotos").on("click",function(){P.filterAll(),dc.redrawAll()}),d3.selectAll("a#resetearRespondidos").on("click",function(){k.filterAll(),dc.redrawAll()}),dc.renderAll(),console.log(E);var q=800,B=100,U={top:58,bottom:100,left:80,right:40},F=q-U.left-U.right,G=(B-U.top-U.bottom,d3.time.format("%H:%M:%S").parse),H=d3.time.scale().domain([G("00:00:00"),G("24:00:00")]).range([0,F]),z=d3.select("#capad3Hora").append("svg").attr("id","chart").attr("width",q).attr("height",B).attr("id","chart").attr("width",q).attr("height",B);z.selectAll(".bar").data(e.features).enter().append("circle").attr("class","point").attr("r",10).attr("cx",function(e){var t=G(e.properties.hora);return H(t)}).attr("cy",20)});e.filtrarPorValor=function(){d3.selectAll("#capad3Hora svg").remove(),map.removeLayer(r),t.llamarFiltroporHora({callback:a,horaInicial:e.horaInicialFiltro,horaFinal:e.horaFinalFiltro})},t.llamarFiltroporHora({callback:a,horaInicial:0,horaFinal:24})}]);