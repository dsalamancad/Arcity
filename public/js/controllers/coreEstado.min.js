var my_angular_app=angular.module("my_angular_app",[]);my_angular_app.service("coneccion",function(){var e=io(),t={};e.on("mapaFiltrado",function(e){t[e.guid](e.geojson),delete t[e.guid]}),e.on("manzanasFiltradas",function(e){t[e.guid](e.geojson),delete t[e.guid]}),e.on("reportesPorManzanasFiltradas",function(e){t[e.guid](e.geojson),delete t[e.guid]});var n=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},r=function(r){var i=n();t[i]=r.callback,r.caller=i,e.emit("filtrarHora",r)},i=function(r){var i=n();t[i]=r.callback,r.caller=i,e.emit("llamarManzanas",r)},a=function(r){var i=n();t[i]=r.callback,r.caller=i,e.emit("llamarReportesPorManzanas",r)};return{llamarFiltroporHora:r,llamarFiltroManzanas:i,llamarFiltroReportesPorManzanas:a}}),my_angular_app.controller("home_controller",["$scope","coneccion",function(e,t){var i,a,o,s,u,l,c,f,h,$e,n=1,m=(io(),{}),v={},y={},_={},b={},E={},x={},w={},T={},A={},S={},R={},C={},N={},P={},O=new Date(2015,0,1),k=new Date(2016,10,1),I={color:"#fff",weight:1,opacity:1},M={color:"#0070bb",weight:.5,opacity:1},D={color:"#30bb51",weight:.5,opacity:1},q={color:"#bc6731",weight:.5,opacity:1},B={color:"#ffb92e",weight:.5,opacity:1},U={color:"#e31b20",weight:.5,opacity:1},F={color:"#5a31bc",weight:.5,opacity:1},j={color:"#dfdc13",weight:.5,opacity:1},G=10,H=10,z=10,$=10,W=10,V=10,Z=10,Y=["m1","m2","m3","m4","m5","m6","m7","m8","m9","m10","m11","m12","m13","m14","m15","m16","m17","m18","m19","m20","m21","m22","m23","m24","m25","m26","m27","m28","m29","m30","m31","m32","m33","m34","m35","m36","m37","m38","m39","m40","m41","m42","m43","m44","m45","m46","m47","m48"],K=[],X=[],Q=[],J=[],ee=[],te=[],ne=[],re=[],ie=[],ae=[],oe=[],se=[],ue=[],le=[],ce=[],fe=[],he=[],pe=[],de=[],ge=[],me=[],ve=[],ye=[],_e=[],be=[],Ee=[],xe=[],we=[],Te=[],Le=[],Ae=[],Se=[],Re=[],Ce=[],Ne=[],Pe=[],Oe=[],ke=[],Ie=[],Me=[],De=[],qe=[],Be=[],Ue=[],Fe=[],je=[],Ge=[],He=[],ze=[K,X,Q,J,ee,te,ne,re,ie,ae,oe,se,ue,le,ce,fe,he,pe,de,ge,me,ve,ye,_e,be,Ee,xe,we,Te,Le,Ae,Se,Re,Ce,Ne,Pe,Oe,ke,Ie,Me,De,qe,Be,Ue,Fe,je,Ge,He];e.cambiarPesos=function(){G=e.pesoPolicia,H=e.pesoArboles,z=e.pesoBasuras,$=e.pesoAcceso,W=e.pesoJuegos,V=e.pesoSillas,Z=e.pesoLuz};var We=function(e){i=L.geoJson(e,{style:function(e){return{stroke:!1,color:"#fff",fillColor:"#0a2438",radius:2,fillOpacity:.5}},pointToLayer:function(e,t){return L.circleMarker(t,I)},onEachFeature:function(e,t){t.bindPopup(e.properties.descripcio)}}),i.addTo(Je)},Ve=function(e){a=L.geoJson(e,{style:I}),o=L.geoJson(e,{style:M}),s=L.geoJson(e,{style:D}),u=L.geoJson(e,{style:q}),l=L.geoJson(e,{style:B}),c=L.geoJson(e,{style:U}),f=L.geoJson(e,{style:F}),h=L.geoJson(e,{style:j}),t.llamarFiltroReportesPorManzanas({callback:Ze,fechaInicial:O,fechaFinal:k}),a.addTo(Je),o.addTo(et),s.addTo(tt),u.addTo(nt),l.addTo(rt),c.addTo(it),f.addTo(at),h.addTo(ot)},Ze=function(e){K=[],X=[],Q=[],J=[],ee=[],te=[],ne=[],re=[],ie=[],ae=[],oe=[],se=[],ue=[],le=[],ce=[],fe=[],he=[],pe=[],de=[],ge=[],me=[],ve=[],ye=[],_e=[],be=[],Ee=[],xe=[],we=[],Te=[],Le=[],Ae=[],Se=[],Re=[],Ce=[],Ne=[],Pe=[],Oe=[],ke=[],Ie=[],Me=[],De=[],qe=[],Be=[],Ue=[],Fe=[],je=[],Ge=[],He=[],ze=[K,X,Q,J,ee,te,ne,re,ie,ae,oe,se,ue,le,ce,fe,he,pe,de,ge,me,ve,ye,_e,be,Ee,xe,we,Te,Le,Ae,Se,Re,Ce,Ne,Pe,Oe,ke,Ie,Me,De,qe,Be,Ue,Fe,je,Ge,He];for(var t=0;t<e.length;t++)ze[t].push(Number(e[t].policias));for(var t=0;t<e.length;t++)ze[t].push(Number(e[t].arbol));for(var t=0;t<e.length;t++)ze[t].push(Number(e[t].caneca));for(var t=0;t<e.length;t++)ze[t].push(Number(e[t].estacion));for(var t=0;t<e.length;t++)ze[t].push(Number(e[t].juego));for(var t=0;t<e.length;t++)ze[t].push(Number(e[t].silla));for(var t=0;t<e.length;t++)ze[t].push(Number(e[t].luz));for(var t=0;t<e.length;t++)ze[t].push(Y[t]);d3.select("#graficaCoordenadasParalelas").html(""),$e=d3.parcoords()("#graficaCoordenadasParalelas").data(ze).render().createAxes().brushMode("1D-axes").color("rgba(0,200,0,0.3)").alphaOnBrushed(.6).brushedColor("#000"),d3.select("#reseteoBrushParalel").on("click",function(){$e.brushReset()});for(var r=(d3.max(e,function(e){return Number(e.totale)}),d3.max(e,function(e){return Number(e.policias)})),i=d3.max(e,function(e){return Number(e.arbol)}),a=d3.max(e,function(e){return Number(e.caneca)}),o=d3.max(e,function(e){return Number(e.estacion)}),s=d3.max(e,function(e){return Number(e.juego)}),u=d3.max(e,function(e){return Number(e.silla)}),l=d3.max(e,function(e){return Number(e.luz)}),c=[],f=d3.max(c),h=G+H+z+$+W+V+Z,t=0;t<e.length;t++){var p=Number(e[t].policias)*G+Number(e[t].arbol)*H+Number(e[t].caneca)*z+Number(e[t].estacion)*$+Number(e[t].juego)*W+Number(e[t].silla)*V+Number(e[t].luz)*Z,d=p/h;c.push(d)}f=d3.max(c);for(var t=0;t<e.length;t++)c[t]>=0&&c[t]<=f/4?m[e[t].gid]=.1:c[t]>f/4&&c[t]<=f/4*2?m[e[t].gid]=.4:c[t]>f/4*2&&c[t]<=f/4*3?m[e[t].gid]=.7:m[e[t].gid]=1,T[e[t].gid]=e[t].policias,A[e[t].gid]=e[t].caneca,S[e[t].gid]=e[t].silla,R[e[t].gid]=e[t].estacion,C[e[t].gid]=e[t].juego,N[e[t].gid]=e[t].arbol,P[e[t].gid]=e[t].luz;for(var t=0;t<e.length;t++)e[t].policias>=0&&e[t].policias<=r/4?v[e[t].gid]=.1:e[t].policias>r/4&&e[t].policias<=r/4*2?v[e[t].gid]=.4:e[t].policias>r/4*2&&e[t].policias<=r/4*3?v[e[t].gid]=.7:v[e[t].gid]=1;for(var t=0;t<e.length;t++)e[t].arbol>=0&&e[t].arbol<=i/4?y[e[t].gid]=.1:e[t].arbol>i/4&&e[t].arbol<=i/4*2?y[e[t].gid]=.4:e[t].arbol>i/4*2&&e[t].arbol<=i/4*3?y[e[t].gid]=.7:y[e[t].gid]=1;for(var t=0;t<e.length;t++)e[t].caneca>=0&&e[t].caneca<=a/4?_[e[t].gid]=.1:e[t].caneca>a/4&&e[t].caneca<=a/4*2?_[e[t].gid]=.4:e[t].caneca>a/4*2&&e[t].caneca<=a/4*3?_[e[t].gid]=.7:_[e[t].gid]=1;for(var t=0;t<e.length;t++)e[t].estacion>=0&&e[t].estacion<=o/4?b[e[t].gid]=.1:e[t].estacion>o/4&&e[t].estacion<=o/4*2?b[e[t].gid]=.4:e[t].estacion>o/4*2&&e[t].estacion<=o/4*3?b[e[t].gid]=.7:b[e[t].gid]=1;for(var t=0;t<e.length;t++)e[t].juego>=0&&e[t].juego<=s/4?E[e[t].gid]=.1:e[t].juego>s/4&&e[t].juego<=s/4*2?E[e[t].gid]=.4:e[t].juego>s/4*2&&e[t].juego<=s/4*3?E[e[t].gid]=.7:E[e[t].gid]=1;for(var t=0;t<e.length;t++)e[t].silla>=0&&e[t].silla<=u/4?x[e[t].gid]=.1:e[t].silla>u/4&&e[t].silla<=u/4*2?x[e[t].gid]=.4:e[t].silla>u/4*2&&e[t].silla<=u/4*3?x[e[t].gid]=.7:x[e[t].gid]=1;for(var t=0;t<e.length;t++)e[t].luz>=0&&e[t].luz<=l/4?w[e[t].gid]=.1:e[t].luz>l/4&&e[t].luz<=l/4*2?w[e[t].gid]=.4:e[t].luz>l/4*2&&e[t].luz<=l/4*3?w[e[t].gid]=.7:w[e[t].gid]=1;Ye()},Ye=function(){for(each in a._layers){var e=a._layers[each],t=e.feature.properties.gid,r=m[t];e.on("click",function(){alertaManzana=this.feature.properties.gid}),e.setStyle({fillColor:"#144a78",color:"#fff",fillOpacity:r}),e.bindPopup("<div id='popUpPoligono'><div id='elementosUsados'><div id='tituloPop'><span>Reportes:</span></div><div><img src='imagenes/iconos/iconoPolicia.png'><span>"+T[t]+"</span></div><div><img src='imagenes/iconos/iconoArbol.png'><span>"+N[t]+"</span></div><div><img src='imagenes/iconos/iconoCaneca.png'><span>"+A[t]+"</span></div><div><img src='imagenes/iconos/iconoEstacion.png'><span>"+R[t]+"</span></div><div><img src='imagenes/iconos/iconoJuego.png'><span>"+C[t]+"</span></div><div><img src='imagenes/iconos/iconoSilla.png'><span>"+S[t]+"</span></div><div><img src='imagenes/iconos/iconoLuz.png'><span>"+P[t]+"</span></div></div><div class='divBotonEnviar'><a id='popupFormulario' onclick='crearFormulario()'>Crear Alerta</a></div></div>"),1==n&&(label=new L.Label,label.setContent(String(e.feature.properties.gid)),label.setLatLng(a._layers[each].getBounds().getCenter()),Je.showLabel(label))}n=0;for(each in o._layers){var e=o._layers[each],t=e.feature.properties.gid,r=v[t];e.setStyle({fillOpacity:r})}for(each in s._layers){var e=s._layers[each],t=e.feature.properties.gid,r=y[t];e.setStyle({fillOpacity:r})}for(each in u._layers){var e=u._layers[each],t=e.feature.properties.gid,r=_[t];e.setStyle({fillOpacity:r})}for(each in l._layers){var e=l._layers[each],t=e.feature.properties.gid,r=b[t];e.setStyle({fillOpacity:r})}for(each in c._layers){var e=c._layers[each],t=e.feature.properties.gid,r=E[t];e.setStyle({fillOpacity:r})}for(each in f._layers){var e=f._layers[each],t=e.feature.properties.gid,r=x[t];e.setStyle({fillOpacity:r})}for(each in h._layers){var e=h._layers[each],t=e.feature.properties.gid,r=w[t];e.setStyle({fillOpacity:r})}};e.filtrarManzanas=function(){if(d3.event.sourceEvent){var e=ft.extent(),n=e.map(d3.time.day.round);n[0]>=n[1]&&(n[0]=d3.time.day.floor(e[0]),n[1]=d3.time.day.ceil(e[1])),d3.select(this).transition().call(ft.extent(n)).call(ft.event),fechaInicial=ft.extent()[0],fechaFinal=ft.extent()[1],document.getElementById("desde").innerHTML=String(ft.extent()[0].getDate())+" / "+String(ft.extent()[0].getMonth())+" / "+String(ft.extent()[0].getFullYear()),horaInicio=String(ft.extent()[0].getDate()),document.getElementById("hasta").innerHTML=String(ft.extent()[1].getDate())+" / "+String(ft.extent()[1].getMonth())+" / "+String(ft.extent()[1].getFullYear()),O=fechaInicial,k=fechaFinal,Je.removeLayer(a),Je.removeLayer(i),et.removeLayer(o),tt.removeLayer(s),nt.removeLayer(u),rt.removeLayer(l),it.removeLayer(c),at.removeLayer(f),ot.removeLayer(h),t.llamarFiltroManzanas({callback:Ve}),t.llamarFiltroporHora({callback:We})}},t.llamarFiltroManzanas({callback:Ve}),t.llamarFiltroporHora({callback:We});var Ke="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",Xe='Map data Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',Je=(new L.TileLayer(Ke,{maxZoom:16,attribution:Xe}),L.map("mapEstado").setView([4.60723,-74.0692],16));Je.addLayer(new L.TileLayer(Ke,{maxZoom:18,opacity:.3}));var et=L.map("mapaPolicia").setView([4.607038,-74.068819],13.5),tt=L.map("mapaArboles").setView([4.607038,-74.068819],13.5),nt=L.map("mapaBasuras").setView([4.607038,-74.068819],13.5),rt=L.map("mapaAcceso").setView([4.607038,-74.068819],13.5),it=L.map("mapaJuegos").setView([4.607038,-74.068819],13.5),at=L.map("mapaSillas").setView([4.607038,-74.068819],13.5),ot=L.map("mapaLuz").setView([4.607038,-74.068819],13.5);Je._layersMaxZoom=18,Je._layersMinZoom=16,L.control.scale({position:"bottomleft",imperial:!1}).addTo(Je),et._layersMaxZoom=14,et._layersMinZoom=14,tt._layersMaxZoom=14,tt._layersMinZoom=14,nt._layersMaxZoom=14,nt._layersMinZoom=14,rt._layersMaxZoom=14,rt._layersMinZoom=14,it._layersMaxZoom=14,it._layersMinZoom=14,at._layersMaxZoom=14,at._layersMinZoom=14,ot._layersMaxZoom=14,ot._layersMinZoom=14;var st={top:0,right:0,bottom:20,left:0},ut=930-st.left-st.right,lt=70-st.top-st.bottom,ct=d3.time.scale().domain([new Date(2014,12,1),new Date(2016,5,1)-1]).range([0,ut]),ft=d3.svg.brush().x(ct).extent([new Date(2015,1,1),new Date(2016,3,1)]).on("brushend",e.filtrarManzanas);document.getElementById("desde").innerHTML=String(ft.extent()[0].getDate())+" / "+String(ft.extent()[0].getMonth())+" / "+String(ft.extent()[0].getFullYear()),document.getElementById("hasta").innerHTML=String(ft.extent()[1].getDate())+" / "+String(ft.extent()[1].getMonth())+" / "+String(ft.extent()[1].getFullYear());var ht=d3.select("body #timeLineControlEstado").append("svg").attr("width",ut+st.left+st.right).attr("height",lt+st.top+st.bottom).append("g").attr("transform","translate("+st.left+","+st.top+")");ht.append("rect").attr("class","grid-background").attr("width",ut).attr("height",lt),ht.append("g").attr("class","x grid").attr("transform","translate(0,"+lt+")").call(d3.svg.axis().scale(ct).orient("bottom").ticks(d3.time.days,52).tickSize(-lt).tickFormat("")).selectAll(".tick").classed("minor",function(e){return e.getHours()}),ht.append("g").attr("class","x axis").attr("transform","translate(0,"+lt+")").call(d3.svg.axis().scale(ct).orient("bottom").ticks(d3.time.months).tickPadding(0)).selectAll("text").attr("x",6).style("text-anchor",null);var pt=ht.append("g").attr("class","brush").call(ft).call(ft.event);pt.selectAll("rect").attr("height",lt)}]);