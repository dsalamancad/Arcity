function consultarMapaFiltrado(a,r){geo.geoQuery({tableName:"aleatoriosmil",geometry:"geom",properties:["id","usuario","fecha","descripcio","seguidores","respondido"]},function(a){r(a)})}function consultarManzanasEnDB(a,r){geo.geoQuery({tableName:"manzanasbarriolasnieves",geometry:"geom",properties:["gid"]},function(a){r(a)})}function consultarReportesenManzanasEnDB(a,r){geo.query({querystring:"SELECT manzanasbarriolasnieves.gid,count(aleatoriosmil.geom) AS totale FROM public.manzanasbarriolasnieves LEFT JOIN public.aleatoriosmil ON st_contains(manzanasbarriolasnieves.geom,aleatoriosmil.geom) GROUP BY manzanasbarriolasnieves.gid"},function(a){r(a)})}var express=require("express"),app=express(),puerto=process.env.PORT||5e3;app.use(express["static"](__dirname+"/public")),app.get("/",function(a,r){r.sendFile(__dirname+"/public/index.html")});var server=app.listen(puerto,function(){var a=server.address().address,r=server.address().port;console.log("Example app listening at http://%s:%s",a,r)}),io=require("socket.io")(server),geo=require("geotabuladb");geo.setCredentials({type:"postgis",host:"localhost",user:"geotabula",password:"geotabula",database:"geotabula"}),io.on("connection",function(a){a.on("filtrarHora",function(r){consultarMapaFiltrado(r,function(o){a.emit("mapaFiltrado",{guid:r.caller,geojson:o})})}),a.on("llamarManzanas",function(r){consultarManzanasEnDB(r,function(o){a.emit("manzanasFiltradas",{guid:r.caller,geojson:o})})}),a.on("llamarReportesPorManzanas",function(r){consultarReportesenManzanasEnDB(r,function(o){a.emit("reportesPorManzanasFiltradas",{guid:r.caller,geojson:o})})}),a.on("error",function(a){console.log(a)})});