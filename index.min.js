function consultarMapaFiltrado(e,a){geo.geoQuery({tableName:"reportes",geometry:"geom",properties:["id","usuario","fecha","descripcio","seguidores","respondido","policia","caneca","silla","estacion","juego","arbol","luz"]},function(e){a(e)})}function consultarManzanasEnDB(e,a){geo.geoQuery({tableName:"manzanasbarriolasnieves",geometry:"geom",properties:["gid"]},function(e){a(e)})}function consultarReportesenManzanasEnDB(e,a){geo.query({querystring:"SELECT manzanasbarriolasnieves.gid as gid,count(reportes.geom) AS totale,sum(reportes.policia) as policias,sum(reportes.caneca) as caneca,sum(reportes.silla) as silla,sum(reportes.estacion) as estacion,sum(reportes.juego) as juego,sum(reportes.arbol) as arbol,sum(reportes.luz) as luz FROM public.manzanasbarriolasnieves LEFT JOIN public.reportes ON st_contains(manzanasbarriolasnieves.geom,reportes.geom) AND reportes.fecha <='"+e.fechaFinal+"'::date AND reportes.fecha>='"+e.fechaInicial+"'::date GROUP BY manzanasbarriolasnieves.gid ORDER BY manzanasbarriolasnieves.gid"},function(e){a(e)})}function consultarReportesPorSemana(e,a){geo.query({querystring:"SELECT date_trunc('week',reportes.fecha) as semana,count(*) as cantidadReportes,sum(reportes.policia) as policias,sum(reportes.caneca) as caneca,sum(reportes.silla) as silla,sum(reportes.estacion) as estacion,sum(reportes.juego) as juego,sum(reportes.arbol) as arbol,sum(reportes.luz) as luz FROM public.reportes GROUP BY semana ORDER BY semana;"},function(e){a(e)})}var express=require("express"),app=express(),puerto=process.env.PORT||5e3;app.use(express["static"](__dirname+"/public")),app.get("/",function(e,a){a.sendFile(__dirname+"/public/index.html")});var server=app.listen(puerto,function(){var e=server.address().address,a=server.address().port;console.log("Example app listening at http://%s:%s",e,a)}),io=require("socket.io")(server),geo=require("geotabuladb");geo.setCredentials({type:"postgis",host:"localhost",user:"geotabula",password:"geotabula",database:"geotabula"}),io.on("connection",function(e){e.on("filtrarHora",function(a){consultarMapaFiltrado(a,function(s){e.emit("mapaFiltrado",{guid:a.caller,geojson:s})})}),e.on("llamarManzanas",function(a){consultarManzanasEnDB(a,function(s){e.emit("manzanasFiltradas",{guid:a.caller,geojson:s})})}),e.on("llamarReportesPorManzanas",function(a){consultarReportesenManzanasEnDB(a,function(s){e.emit("reportesPorManzanasFiltradas",{guid:a.caller,geojson:s})})}),e.on("error",function(e){console.log(e)})});